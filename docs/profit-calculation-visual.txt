═══════════════════════════════════════════════════════════════════════════
                     PROFIT CALCULATION ARCHITECTURE
                            VISUAL DIAGRAM
═══════════════════════════════════════════════════════════════════════════

┌──────────────────────────────────────────────────────────────────────────┐
│                          SUPABASE DATABASE                               │
│                                                                          │
│  ┌────────────────────┐          ┌────────────────────┐                │
│  │   REVENUE TABLES   │          │   EXPENSE TABLES   │                │
│  ├────────────────────┤          ├────────────────────┤                │
│  │ finance_payments   │          │ finance_expenses   │                │
│  │   amount: 5000     │          │   category:        │                │
│  │   status: ✓        │          │   - Materials      │                │
│  │                    │          │   - Equipment      │                │
│  │ invoice_payments   │          │   - Supplies       │                │
│  │   amount: 2000     │          │   - Rent, etc.     │                │
│  │                    │          │                    │                │
│  │ invoices           │          │ employee_payments  │ ← MISSING      │
│  │   balance: 3000    │          │   amount: 2000     │                │
│  │   (outstanding)    │          │   status: ✓        │                │
│  │                    │          │                    │                │
│  │                    │          │ contractor_payments│ ← MISSING      │
│  │                    │          │   amount: 1500     │                │
│  │                    │          │   status: ✓        │                │
│  │                    │          │                    │                │
│  │                    │          │ recurring_expenses │ ← PARTIAL      │
│  │                    │          │   amount: 1000     │                │
│  │                    │          │   frequency:       │                │
│  │                    │          │   monthly/yearly   │                │
│  └────────────────────┘          └────────────────────┘                │
└──────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌──────────────────────────────────────────────────────────────────────────┐
│                    financeStoreSupabase.ts (LOGIC)                       │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  calculateFinancialSummary()                                   │    │
│  │                                                                 │    │
│  │  ╔═══════════════════════════════════════════════════════════╗ │    │
│  │  ║                CURRENT (WRONG)                            ║ │    │
│  │  ╠═══════════════════════════════════════════════════════════╣ │    │
│  │  ║  expenses = receipts.reduce(...)                          ║ │    │
│  │  ║                                                            ║ │    │
│  │  ║  ❌ ONLY includes finance_expenses                        ║ │    │
│  │  ║  ❌ Missing 5 other expense tables                        ║ │    │
│  │  ╚═══════════════════════════════════════════════════════════╝ │    │
│  │                                                                 │    │
│  │  ╔═══════════════════════════════════════════════════════════╗ │    │
│  │  ║                CORRECT (NEW)                              ║ │    │
│  │  ╠═══════════════════════════════════════════════════════════╣ │    │
│  │  ║  directCosts = receipts(Materials, Equipment)             ║ │    │
│  │  ║                + contractor_payments                       ║ │    │
│  │  ║                                                            ║ │    │
│  │  ║  laborCosts = employee_payments                           ║ │    │
│  │  ║                                                            ║ │    │
│  │  ║  operatingExpenses = receipts(Supplies, General)          ║ │    │
│  │  ║                                                            ║ │    │
│  │  ║  overheadCosts = receipts(Rent, Utilities)                ║ │    │
│  │  ║                  + recurring_expenses (prorated)           ║ │    │
│  │  ║                                                            ║ │    │
│  │  ║  expenses = directCosts + laborCosts                      ║ │    │
│  │  ║             + operatingExpenses + overheadCosts            ║ │    │
│  │  ║                                                            ║ │    │
│  │  ║  ✅ Includes ALL 6 expense categories                     ║ │    │
│  │  ╚═══════════════════════════════════════════════════════════╝ │    │
│  └────────────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌──────────────────────────────────────────────────────────────────────────┐
│                      financialSummary.monthlyData                        │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  [                                                             │    │
│  │    {                                                           │    │
│  │      month: "Oct 2025",                                        │    │
│  │      revenue: 10000,        ← From finance_payments           │    │
│  │                                                                │    │
│  │      expenses: 9000,        ← NOW INCLUDES ALL:               │    │
│  │        directCosts: 3500,      - Materials (1200)             │    │
│  │        laborCosts: 3800,       - Contractors (1500)           │    │
│  │        operatingExpenses: 450, - Equipment (800)              │    │
│  │        overheadCosts: 1250,    - Employees (3800)             │    │
│  │                                - Supplies (450)               │    │
│  │      profit: 1000,             - Recurring (1250)             │    │
│  │      profitMargin: 10.0                                       │    │
│  │    },                                                          │    │
│  │    { ... 5 more months ... }                                  │    │
│  │  ]                                                             │    │
│  └────────────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌──────────────────────────────────────────────────────────────────────────┐
│               FinanceSummaryChart.tsx (DISPLAY)                          │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                          Chart                                 │    │
│  │                                                                │    │
│  │  ┌────┐                                                        │    │
│  │  │ R  │ 10,000  ← Revenue (blue bar)                          │    │
│  │  │ E  │                                                        │    │
│  │  │ V  │                                                        │    │
│  │  │    │                                                        │    │
│  │  ├────┤                                                        │    │
│  │  │ E  │  9,000  ← Expenses (teal bar)                         │    │
│  │  │ X  │                                                        │    │
│  │  │ P  │                                                        │    │
│  │  └────┘                                                        │    │
│  │                                                                │    │
│  │  Profit = 10,000 - 9,000 = $1,000 ✅                          │    │
│  │  Margin = (1,000 / 10,000) × 100 = 10% ✅                     │    │
│  │                                                                │    │
│  │  NO CODE CHANGES NEEDED HERE                                  │    │
│  │  Just displays the calculated data                            │    │
│  └────────────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════
                        EXPENSE BREAKDOWN DETAIL
═══════════════════════════════════════════════════════════════════════════

                         TOTAL EXPENSES: $9,000
                                 │
        ┌────────────────────────┼────────────────────────┐
        │                        │                        │
   DIRECT COSTS           LABOR COSTS              OPERATING + OVERHEAD
      $3,500                 $3,800                       $1,700
        │                        │                            │
    ┌───┴───┐                   │                    ┌───────┴────────┐
    │       │                   │                    │                │
Materials  Equip          Employees            Operating         Overhead
 $1,200    $800           $2,000 × 2           $450            $1,250
           Contractors                         Supplies        Rent + Software
           $1,500                                              $1,000 + $250

═══════════════════════════════════════════════════════════════════════════
                           RECURRING EXPENSES
                         PRORATION CALCULATION
═══════════════════════════════════════════════════════════════════════════

┌──────────────────────────────────────────────────────────────────────────┐
│  Frequency      Amount      Monthly Equivalent                           │
├──────────────────────────────────────────────────────────────────────────┤
│  Weekly         $100        $100 × 4.33  = $433/month                    │
│  Monthly        $1,000      $1,000 × 1   = $1,000/month                  │
│  Quarterly      $600        $600 ÷ 3     = $200/month                    │
│  Yearly         $2,400      $2,400 ÷ 12  = $200/month                    │
└──────────────────────────────────────────────────────────────────────────┘

Example:
  Office Rent: $1,000/month (monthly)   → $1,000
  Software:    $600/quarter (quarterly) → $200
  Insurance:   $2,400/year (yearly)     → $200
  ────────────────────────────────────────────
  Total Overhead from Recurring:          $1,400/month

═══════════════════════════════════════════════════════════════════════════
                         CATEGORY MAPPING TABLE
═══════════════════════════════════════════════════════════════════════════

┌──────────────────────┬─────────────────┬────────────────────────────────┐
│  Category            │  Expense Type   │  Database Source               │
├──────────────────────┼─────────────────┼────────────────────────────────┤
│  Materials           │  DIRECT         │  finance_expenses              │
│  Equipment           │  DIRECT         │  finance_expenses              │
│  Subcontractor       │  DIRECT         │  contractor_payments           │
├──────────────────────┼─────────────────┼────────────────────────────────┤
│  Employee Wages      │  LABOR          │  employee_payments             │
├──────────────────────┼─────────────────┼────────────────────────────────┤
│  Supplies            │  OPERATING      │  finance_expenses              │
│  General             │  OPERATING      │  finance_expenses              │
│  Office              │  OPERATING      │  finance_expenses              │
├──────────────────────┼─────────────────┼────────────────────────────────┤
│  Rent                │  OVERHEAD       │  finance_expenses + recurring  │
│  Utilities           │  OVERHEAD       │  finance_expenses + recurring  │
│  Insurance           │  OVERHEAD       │  finance_expenses + recurring  │
│  Software            │  OVERHEAD       │  finance_expenses + recurring  │
└──────────────────────┴─────────────────┴────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════
                         IMPLEMENTATION CHECKLIST
═══════════════════════════════════════════════════════════════════════════

Step 1: Update Types
  ├─ Add MonthlyFinancialData interface
  ├─ Update FinancialSummary.monthlyData type
  └─ Run: npm run typecheck

Step 2: Modify Calculation
  ├─ Fetch employee_payments from database
  ├─ Fetch contractor_payments from database
  ├─ Calculate directCosts (receipts + contractors)
  ├─ Calculate laborCosts (employees)
  ├─ Calculate operatingExpenses (receipts filtered)
  ├─ Calculate overheadCosts (receipts + recurring prorated)
  └─ Sum: expenses = direct + labor + operating + overhead

Step 3: Remove Export Button
  └─ Delete lines 225-231 in FinanceDashboard.tsx

Step 4: Test
  ├─ Add test data to database
  ├─ Verify calculation in console
  ├─ Check dashboard chart
  └─ Validate profit = revenue - expenses

Step 5: Deploy
  ├─ Commit: "fix: Include all expense categories in profit"
  ├─ Push to repository
  └─ Monitor production

═══════════════════════════════════════════════════════════════════════════
                            FILES TO MODIFY
═══════════════════════════════════════════════════════════════════════════

📁 src/stores/financeStoreSupabase.ts
   │
   ├─ Lines ~178: Add MonthlyFinancialData interface
   ├─ Lines ~149: Update FinancialSummary interface
   └─ Lines 1688-1714: Rewrite calculateFinancialSummary monthly loop

📁 src/components/finance/FinanceDashboard.tsx
   │
   └─ Lines 225-231: Delete export button

📁 No changes needed:
   ├─ src/components/dashboard/FinanceSummaryChart.tsx ✅
   ├─ src/pages/Dashboard.tsx ✅
   └─ Database schema ✅

═══════════════════════════════════════════════════════════════════════════
                         TIME & EFFORT ESTIMATE
═══════════════════════════════════════════════════════════════════════════

┌──────────────────────┬──────────────┬─────────────────────────────────┐
│  Task                │  Time        │  Description                    │
├──────────────────────┼──────────────┼─────────────────────────────────┤
│  Read Documentation  │  30 min      │  Understand problem & solution  │
│  Update Types        │  15 min      │  Add interfaces                 │
│  Implement Logic     │  2 hours     │  Rewrite calculation function   │
│  Remove Export       │  5 min       │  Delete button code             │
│  Testing             │  1 hour      │  Verify with test data          │
│  Deploy              │  30 min      │  Commit, push, monitor          │
├──────────────────────┼──────────────┼─────────────────────────────────┤
│  TOTAL               │  3-4 hours   │  Complete implementation        │
└──────────────────────┴──────────────┴─────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════
                              END OF VISUAL
═══════════════════════════════════════════════════════════════════════════

For detailed implementation instructions, see:
  - docs/profit-fix-implementation-guide.md (step-by-step)
  - docs/profit-calculation-architecture.md (full technical spec)
  - docs/profit-calculation-formula.md (formula reference)
  - docs/ARCHITECTURE_SUMMARY.md (high-level overview)

Created: 2025-10-18
Version: 1.0
