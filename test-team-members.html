<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Team Members</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: system-ui, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .member-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <h1>Test Team Members Functionality</h1>

    <div class="section">
        <h2>Select Project</h2>
        <select id="projectSelect">
            <option value="">Select a project...</option>
        </select>
        <button onclick="loadProjects()">Refresh Projects</button>
    </div>

    <div class="section">
        <h2>Add Team Member</h2>
        <input type="text" id="memberName" placeholder="Member Name" />
        <input type="email" id="memberEmail" placeholder="Email (optional)" />
        <input type="text" id="memberRole" placeholder="Role (optional)" />
        <button onclick="addTeamMember()">Add Member</button>
    </div>

    <div class="section">
        <h2>Current Team Members</h2>
        <div id="teamList">Select a project first...</div>
    </div>

    <div class="section">
        <h2>Console Output</h2>
        <div id="console" style="background: #1e293b; color: #0ea5e9; padding: 15px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto;"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ujhgwcurllkkeouzwvgk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVqaGd3Y3VybGxra2VvdXp3dmdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMzIzMjQsImV4cCI6MjA3MjYwODMyNH0.ez6RDJ2FxgSfb7mo2Xug1lXaynKLR-2nJFO-x64UNnY';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        function log(message, type = 'info') {
            const consoleDiv = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#0ea5e9';
            consoleDiv.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            console.log(message);
        }

        async function loadProjects() {
            try {
                log('Loading projects...');
                const { data: projects, error } = await supabase
                    .from('projects')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    log(`Error loading projects: ${error.message}`, 'error');
                    return;
                }
                
                const select = document.getElementById('projectSelect');
                select.innerHTML = '<option value="">Select a project...</option>';
                
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    select.appendChild(option);
                });
                
                log(`Loaded ${projects.length} projects`, 'success');
            } catch (err) {
                log(`Exception: ${err.message}`, 'error');
            }
        }

        async function loadTeamMembers() {
            const projectId = document.getElementById('projectSelect').value;
            if (!projectId) {
                document.getElementById('teamList').innerHTML = 'Select a project first...';
                return;
            }
            
            try {
                log(`Loading team members for project ${projectId}...`);
                const { data: members, error } = await supabase
                    .from('project_team_members')
                    .select('*')
                    .eq('project_id', projectId)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    log(`Error loading team members: ${error.message}`, 'error');
                    return;
                }
                
                const teamList = document.getElementById('teamList');
                if (members.length === 0) {
                    teamList.innerHTML = '<p>No team members yet. Add one above!</p>';
                } else {
                    teamList.innerHTML = members.map(member => `
                        <div class="member-item">
                            <div>
                                <strong>${member.member_name}</strong>
                                ${member.role ? ` - ${member.role}` : ''}
                                ${member.member_email ? ` (${member.member_email})` : ''}
                            </div>
                            <button onclick="removeMember('${member.id}', '${member.member_name}')">Remove</button>
                        </div>
                    `).join('');
                }
                
                log(`Found ${members.length} team members`, 'success');
            } catch (err) {
                log(`Exception: ${err.message}`, 'error');
            }
        }

        async function addTeamMember() {
            const projectId = document.getElementById('projectSelect').value;
            const memberName = document.getElementById('memberName').value;
            const memberEmail = document.getElementById('memberEmail').value;
            const memberRole = document.getElementById('memberRole').value;
            
            if (!projectId) {
                log('Please select a project first!', 'error');
                return;
            }
            
            if (!memberName) {
                log('Please enter a member name!', 'error');
                return;
            }
            
            try {
                log(`Adding team member: ${memberName}...`);
                
                const insertData = {
                    project_id: projectId,
                    member_name: memberName,
                    member_email: memberEmail || null,
                    role: memberRole || null
                };
                
                log(`Insert data: ${JSON.stringify(insertData)}`);
                
                const { data, error } = await supabase
                    .from('project_team_members')
                    .insert(insertData)
                    .select()
                    .single();
                
                if (error) {
                    log(`Error adding team member: ${error.message}`, 'error');
                    log(`Error details: ${JSON.stringify(error)}`, 'error');
                    return;
                }
                
                log(`Successfully added team member: ${data.member_name}`, 'success');
                
                // Clear form
                document.getElementById('memberName').value = '';
                document.getElementById('memberEmail').value = '';
                document.getElementById('memberRole').value = '';
                
                // Reload team members
                loadTeamMembers();
                
            } catch (err) {
                log(`Exception: ${err.message}`, 'error');
            }
        }

        async function removeMember(memberId, memberName) {
            if (!confirm(`Remove ${memberName} from the team?`)) {
                return;
            }
            
            try {
                log(`Removing team member: ${memberName}...`);
                
                const { error } = await supabase
                    .from('project_team_members')
                    .delete()
                    .eq('id', memberId);
                
                if (error) {
                    log(`Error removing team member: ${error.message}`, 'error');
                    return;
                }
                
                log(`Successfully removed team member: ${memberName}`, 'success');
                loadTeamMembers();
                
            } catch (err) {
                log(`Exception: ${err.message}`, 'error');
            }
        }

        // Handle project selection change
        document.getElementById('projectSelect').addEventListener('change', loadTeamMembers);
        
        // Load projects on page load
        window.onload = () => {
            log('Page loaded, initializing...', 'success');
            loadProjects();
        };
    </script>
</body>
</html>