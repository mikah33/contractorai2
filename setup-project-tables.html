<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Project Tables - ContractorAI</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 10px;
        }
        .sql-box {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .btn:hover {
            background: #2563eb;
        }
        .btn-success {
            background: #10b981;
        }
        .btn-success:hover {
            background: #059669;
        }
        .btn-danger {
            background: #ef4444;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }
        .test-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e5e7eb;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            background: #f9fafb;
            border-radius: 4px;
            border-left: 4px solid #6b7280;
        }
        .test-result.pass {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        .test-result.fail {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        pre {
            background: #f3f4f6;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .copy-btn {
            float: right;
            background: #6b7280;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .copy-btn:hover {
            background: #4b5563;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ ContractorAI - Setup Project Tables</h1>
        
        <div id="connectionStatus" class="status info">
            Checking connection to Supabase...
        </div>

        <h2>Step 1: Execute SQL in Supabase</h2>
        <p>Copy this SQL and run it in your Supabase SQL Editor:</p>
        
        <button class="copy-btn" onclick="copySQL()">üìã Copy SQL</button>
        <div class="sql-box" id="sqlContent">-- Drop existing tables if they have user_id constraints
DROP TABLE IF EXISTS tasks CASCADE;
DROP TABLE IF EXISTS comments CASCADE;
DROP TABLE IF EXISTS project_team_members CASCADE;

-- Recreate tasks table WITHOUT user_id
CREATE TABLE tasks (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT,
  status TEXT CHECK (status IN ('todo', 'in-progress', 'completed')) DEFAULT 'todo',
  assignee TEXT,
  due_date TIMESTAMPTZ,
  priority TEXT CHECK (priority IN ('low', 'medium', 'high')) DEFAULT 'medium',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Recreate comments table WITHOUT user_id
CREATE TABLE comments (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  author TEXT NOT NULL,
  content TEXT NOT NULL,
  attachments TEXT[],
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Recreate team_members table WITHOUT user_id
CREATE TABLE project_team_members (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  member_name TEXT NOT NULL,
  member_email TEXT,
  role TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(project_id, member_name)
);

-- Add missing columns to projects table if needed
ALTER TABLE projects ADD COLUMN IF NOT EXISTS priority TEXT CHECK (priority IN ('low', 'medium', 'high')) DEFAULT 'medium';
ALTER TABLE projects ADD COLUMN IF NOT EXISTS spent DECIMAL(12,2) DEFAULT 0;
ALTER TABLE projects ADD COLUMN IF NOT EXISTS progress INTEGER DEFAULT 0 CHECK (progress >= 0 AND progress <= 100);

-- Remove user_id constraint from projects if it exists
ALTER TABLE projects ALTER COLUMN user_id DROP NOT NULL;

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_tasks_project_id ON tasks(project_id);
CREATE INDEX IF NOT EXISTS idx_comments_project_id ON comments(project_id);
CREATE INDEX IF NOT EXISTS idx_team_members_project_id ON project_team_members(project_id);

-- Enable RLS but allow all operations
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE comments ENABLE ROW LEVEL SECURITY;
ALTER TABLE project_team_members ENABLE ROW LEVEL SECURITY;

-- Drop existing policies if they exist
DROP POLICY IF EXISTS "Allow all on tasks" ON tasks;
DROP POLICY IF EXISTS "Allow all on comments" ON comments;
DROP POLICY IF EXISTS "Allow all on project_team_members" ON project_team_members;

-- Create permissive policies
CREATE POLICY "Allow all on tasks" ON tasks
  FOR ALL USING (true) WITH CHECK (true);

CREATE POLICY "Allow all on comments" ON comments
  FOR ALL USING (true) WITH CHECK (true);

CREATE POLICY "Allow all on project_team_members" ON project_team_members
  FOR ALL USING (true) WITH CHECK (true);</div>

        <button class="btn" onclick="openSupabase()">üìä Open Supabase SQL Editor</button>
        
        <div class="test-section">
            <h2>Step 2: Test Database Connection</h2>
            <button class="btn btn-success" onclick="testConnection()">üîå Test Connection</button>
            <button class="btn" onclick="checkTables()">üìã Check Tables</button>
            <div id="testResults"></div>
        </div>

        <div class="test-section">
            <h2>Step 3: Test CRUD Operations</h2>
            <button class="btn btn-success" onclick="runAllTests()">üß™ Run All Tests</button>
            <button class="btn" onclick="testCreateTask()">‚ûï Test Create Task</button>
            <button class="btn" onclick="testCreateComment()">üí¨ Test Create Comment</button>
            <button class="btn" onclick="testFetchAll()">üì• Test Fetch All</button>
            <button class="btn btn-danger" onclick="cleanupTestData()">üóëÔ∏è Cleanup Test Data</button>
            <div id="crudResults"></div>
        </div>

        <div class="test-section">
            <h2>Step 4: Verify in App</h2>
            <p>After running the tests above, check your app:</p>
            <ol>
                <li>Go to <a href="http://localhost:5174/projects" target="_blank">Projects Page</a></li>
                <li>Click on any project</li>
                <li>Try adding a task - it should now save to the database</li>
                <li>Try adding a comment - it should persist</li>
                <li>Refresh the page - all data should remain</li>
            </ol>
            <button class="btn" onclick="window.open('http://localhost:5174/projects', '_blank')">üåê Open Projects Page</button>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://ujhgwcurllkkeouzwvgk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVqaGd3Y3VybGxra2VvdXp3dmdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMzIzMjQsImV4cCI6MjA3MjYwODMyNH0.ez6RDJ2FxgSfb7mo2Xug1lXaynKLR-2nJFO-x64UNnY';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let testProjectId = null;
        let testTaskId = null;
        let testCommentId = null;

        // Test connection on load
        window.onload = async () => {
            await testConnection();
        };

        function copySQL() {
            const sqlContent = document.getElementById('sqlContent').innerText;
            navigator.clipboard.writeText(sqlContent);
            alert('SQL copied to clipboard! Paste it in your Supabase SQL Editor.');
        }

        function openSupabase() {
            window.open('https://app.supabase.com/project/ujhgwcurllkkeouzwvgk/editor', '_blank');
        }

        async function testConnection() {
            const statusEl = document.getElementById('connectionStatus');
            const resultsEl = document.getElementById('testResults');
            
            try {
                // Test basic connection by querying projects
                const { data, error } = await supabase
                    .from('projects')
                    .select('id')
                    .limit(1);
                
                if (error) throw error;
                
                statusEl.className = 'status success';
                statusEl.innerHTML = '‚úÖ Connected to Supabase successfully!';
                resultsEl.innerHTML = '<div class="test-result pass">‚úì Database connection successful</div>';
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.innerHTML = `‚ùå Connection failed: ${error.message}`;
                resultsEl.innerHTML = `<div class="test-result fail">‚úó ${error.message}</div>`;
            }
        }

        async function checkTables() {
            const resultsEl = document.getElementById('testResults');
            let results = [];
            
            // Check if tables exist
            const tables = ['projects', 'tasks', 'comments', 'project_team_members'];
            
            for (const table of tables) {
                try {
                    const { count, error } = await supabase
                        .from(table)
                        .select('*', { count: 'exact', head: true });
                    
                    if (error) {
                        if (error.message.includes('does not exist')) {
                            results.push(`<div class="test-result fail">‚úó Table '${table}' does not exist - Run the SQL above first!</div>`);
                        } else {
                            results.push(`<div class="test-result fail">‚úó Table '${table}': ${error.message}</div>`);
                        }
                    } else {
                        results.push(`<div class="test-result pass">‚úì Table '${table}' exists (${count || 0} rows)</div>`);
                    }
                } catch (err) {
                    results.push(`<div class="test-result fail">‚úó Table '${table}': ${err.message}</div>`);
                }
            }
            
            resultsEl.innerHTML = results.join('');
        }

        async function getTestProject() {
            // Get or create a test project
            let { data: projects } = await supabase
                .from('projects')
                .select('id, name')
                .limit(1);
            
            if (projects && projects.length > 0) {
                testProjectId = projects[0].id;
                return projects[0];
            }
            
            // Create a test project if none exist
            const { data, error } = await supabase
                .from('projects')
                .insert({
                    name: 'Test Project for CRUD',
                    client_id: null,
                    status: 'active',
                    start_date: new Date().toISOString(),
                    end_date: new Date(Date.now() + 30*24*60*60*1000).toISOString(),
                    budget: 10000,
                    description: 'Test project for testing CRUD operations'
                })
                .select()
                .single();
            
            if (error) throw error;
            testProjectId = data.id;
            return data;
        }

        async function testCreateTask() {
            const resultsEl = document.getElementById('crudResults');
            
            try {
                const project = await getTestProject();
                
                // Create a test task
                const { data, error } = await supabase
                    .from('tasks')
                    .insert({
                        project_id: project.id,
                        title: 'Test Task ' + Date.now(),
                        status: 'todo',
                        assignee: 'Test User',
                        due_date: new Date(Date.now() + 7*24*60*60*1000).toISOString(),
                        priority: 'medium',
                        description: 'This is a test task created by the setup script'
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                testTaskId = data.id;
                resultsEl.innerHTML = `
                    <div class="test-result pass">‚úì Task created successfully!</div>
                    <pre>Task ID: ${data.id}
Title: ${data.title}
Project: ${project.name}</pre>
                `;
            } catch (error) {
                resultsEl.innerHTML = `<div class="test-result fail">‚úó Failed to create task: ${error.message}</div>`;
            }
        }

        async function testCreateComment() {
            const resultsEl = document.getElementById('crudResults');
            
            try {
                const project = await getTestProject();
                
                // Create a test comment
                const { data, error } = await supabase
                    .from('comments')
                    .insert({
                        project_id: project.id,
                        author: 'Test User',
                        content: 'This is a test comment created at ' + new Date().toLocaleString(),
                        attachments: []
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                testCommentId = data.id;
                resultsEl.innerHTML = `
                    <div class="test-result pass">‚úì Comment created successfully!</div>
                    <pre>Comment ID: ${data.id}
Author: ${data.author}
Content: ${data.content}</pre>
                `;
            } catch (error) {
                resultsEl.innerHTML = `<div class="test-result fail">‚úó Failed to create comment: ${error.message}</div>`;
            }
        }

        async function testFetchAll() {
            const resultsEl = document.getElementById('crudResults');
            
            try {
                const project = await getTestProject();
                
                // Fetch project with all related data
                const [tasksResult, commentsResult, teamResult] = await Promise.all([
                    supabase.from('tasks').select('*').eq('project_id', project.id),
                    supabase.from('comments').select('*').eq('project_id', project.id),
                    supabase.from('project_team_members').select('*').eq('project_id', project.id)
                ]);
                
                const results = [];
                
                if (tasksResult.error) throw tasksResult.error;
                results.push(`‚úì Found ${tasksResult.data.length} tasks`);
                
                if (commentsResult.error) throw commentsResult.error;
                results.push(`‚úì Found ${commentsResult.data.length} comments`);
                
                if (teamResult.error) throw teamResult.error;
                results.push(`‚úì Found ${teamResult.data.length} team members`);
                
                resultsEl.innerHTML = `
                    <div class="test-result pass">‚úì Fetch test successful!</div>
                    <pre>${results.join('\n')}</pre>
                `;
            } catch (error) {
                resultsEl.innerHTML = `<div class="test-result fail">‚úó Failed to fetch data: ${error.message}</div>`;
            }
        }

        async function runAllTests() {
            const resultsEl = document.getElementById('crudResults');
            resultsEl.innerHTML = '<div class="status info">Running all tests...</div>';
            
            await checkTables();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testCreateTask();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testCreateComment();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testFetchAll();
            
            resultsEl.innerHTML += '<div class="status success">‚úÖ All tests completed! Check results above.</div>';
        }

        async function cleanupTestData() {
            const resultsEl = document.getElementById('crudResults');
            
            if (!confirm('This will delete all test data created by this script. Continue?')) {
                return;
            }
            
            try {
                const results = [];
                
                // Delete test tasks
                if (testTaskId) {
                    const { error } = await supabase
                        .from('tasks')
                        .delete()
                        .eq('id', testTaskId);
                    
                    if (!error) results.push('‚úì Test task deleted');
                }
                
                // Delete test comments
                if (testCommentId) {
                    const { error } = await supabase
                        .from('comments')
                        .delete()
                        .eq('id', testCommentId);
                    
                    if (!error) results.push('‚úì Test comment deleted');
                }
                
                // Delete test project
                if (testProjectId) {
                    const { data } = await supabase
                        .from('projects')
                        .select('name')
                        .eq('id', testProjectId)
                        .single();
                    
                    if (data && data.name === 'Test Project for CRUD') {
                        const { error } = await supabase
                            .from('projects')
                            .delete()
                            .eq('id', testProjectId);
                        
                        if (!error) results.push('‚úì Test project deleted');
                    }
                }
                
                resultsEl.innerHTML = `
                    <div class="test-result pass">‚úì Cleanup complete!</div>
                    <pre>${results.join('\n')}</pre>
                `;
            } catch (error) {
                resultsEl.innerHTML = `<div class="test-result fail">‚úó Cleanup failed: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>