<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Project Creation Fix</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div style="padding: 20px; font-family: Arial, sans-serif;">
        <h1>Test Project Creation Fix</h1>
        <div id="status">Initializing...</div>
        
        <h2>Test Results</h2>
        <div id="results"></div>
        
        <h2>Manual Test</h2>
        <form id="testForm">
            <div style="margin-bottom: 10px;">
                <label>Project Name: <input type="text" id="projectName" value="Test Project" required></label>
            </div>
            <div style="margin-bottom: 10px;">
                <label>Status: 
                    <select id="projectStatus">
                        <option value="planning">Planning</option>
                        <option value="active">Active</option>
                        <option value="completed">Completed</option>
                        <option value="on-hold">On Hold</option>
                    </select>
                </label>
            </div>
            <div style="margin-bottom: 10px;">
                <label>Budget: <input type="number" id="projectBudget" value="10000" required></label>
            </div>
            <div style="margin-bottom: 10px;">
                <label>Description: <textarea id="projectDescription" rows="3">Test project to verify status constraint fix</textarea></label>
            </div>
            <button type="submit">Create Test Project</button>
        </form>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://upocfmtqxmfcxnxboyve.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwb2NmbXRxeG1mY3hueGJveXZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc1NjY4MDEsImV4cCI6MjA1MzE0MjgwMX0.6xW7Q9z5sjJCKgHV6CL5eMPmOTRc9LmzfCPaWcrNIQs';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');
        
        function addResult(text, isError = false) {
            const div = document.createElement('div');
            div.style.color = isError ? 'red' : 'green';
            div.style.marginBottom = '5px';
            div.textContent = text;
            resultsDiv.appendChild(div);
        }

        // Test function to create project with each valid status
        async function testProjectCreation() {
            statusDiv.textContent = 'Testing project creation with corrected status values...';
            
            const validStatuses = ['planning', 'active', 'completed', 'on-hold'];
            
            for (const status of validStatuses) {
                try {
                    const projectData = {
                        name: `Test Project - ${status}`,
                        status: status,
                        budget: 5000 + Math.floor(Math.random() * 1000),
                        description: `Test project with ${status} status to verify database constraint fix`,
                        start_date: new Date().toISOString().split('T')[0],
                        end_date: new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0] // 30 days from now
                    };
                    
                    const { data, error } = await supabase
                        .from('projects')
                        .insert(projectData)
                        .select()
                        .single();
                    
                    if (error) {
                        addResult(`❌ Failed to create project with status '${status}': ${error.message}`, true);
                    } else {
                        addResult(`✅ Successfully created project with status '${status}' (ID: ${data.id})`);
                    }
                } catch (err) {
                    addResult(`❌ Exception when creating project with status '${status}': ${err.message}`, true);
                }
            }
            
            // Test invalid status to ensure constraint still works
            try {
                const { data, error } = await supabase
                    .from('projects')
                    .insert({
                        name: 'Test Invalid Status',
                        status: 'invalid-status',
                        budget: 1000,
                        description: 'This should fail'
                    });
                
                if (error) {
                    addResult(`✅ Correctly rejected invalid status: ${error.message}`);
                } else {
                    addResult(`❌ Incorrectly accepted invalid status`, true);
                }
            } catch (err) {
                addResult(`✅ Correctly rejected invalid status: ${err.message}`);
            }
            
            statusDiv.textContent = 'Testing completed!';
        }

        // Manual form submission
        document.getElementById('testForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('projectName').value,
                status: document.getElementById('projectStatus').value,
                budget: parseFloat(document.getElementById('projectBudget').value),
                description: document.getElementById('projectDescription').value,
                start_date: new Date().toISOString().split('T')[0],
                end_date: new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0]
            };
            
            try {
                const { data, error } = await supabase
                    .from('projects')
                    .insert(formData)
                    .select()
                    .single();
                
                if (error) {
                    addResult(`❌ Manual test failed: ${error.message}`, true);
                } else {
                    addResult(`✅ Manual test successful! Created project ID: ${data.id}`);
                }
            } catch (err) {
                addResult(`❌ Manual test exception: ${err.message}`, true);
            }
        });

        // Run automatic tests
        testProjectCreation();
    </script>
</body>
</html>